<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image-to-Image Generation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Firebase Configuration ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId;

        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            const generateBtnForAuth = document.getElementById('generate-btn');

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User authenticated with private UID:", userId);
                    // Enable the button now that we have a user ID
                    generateBtnForAuth.disabled = false;
                    generateBtnForAuth.textContent = 'Generate Image';
                }
            });

            // Trigger the sign-in process
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

        } catch (e) {
            console.error("Firebase initialization failed:", e);
            const generateBtnForAuth = document.getElementById('generate-btn');
            generateBtnForAuth.textContent = 'Connection Failed';
        }
        
        // --- Function to Save Uploads to a PRIVATE Collection ---
        window.saveUploadForRecord = async (imageData, mimeType, promptText) => {
            if (!db || !userId) {
                console.error("Firestore not initialized or user not authenticated. Cannot save record.");
                alert("Could not connect to the database. Please refresh and try again.");
                return;
            }
            try {
                // This path saves data under a unique ID for each user.
                const collectionPath = `/artifacts/${appId}/users/${userId}/uploads`;
                await addDoc(collection(db, collectionPath), {
                    imageData: imageData, 
                    mimeType: mimeType,
                    prompt: promptText,
                    timestamp: serverTimestamp() 
                });
                console.log("Upload record saved successfully to a private collection.");
            } catch (error) {
                console.error("Error saving upload record to Firestore:", error);
            }
        };

    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .file-input-label {
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
             width: 100%;
             height: 100%;
             border: 2px dashed #4a5568;
             border-radius: 0.5rem;
             padding: 2rem;
             text-align: center;
             color: #a0aec0;
             transition: border-color 0.2s;
        }
        .file-input-wrapper:hover .file-input-label {
            border-color: #4299e1;
        }
        #image-preview {
            max-width: 100%;
            max-height: 250px;
            object-fit: contain;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex flex-col items-center justify-center min-h-screen py-10">

    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-4xl mx-4">
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-white">Image-to-Image Generation</h1>
            <p class="text-gray-400 mt-2">Upload an image, provide a prompt, and let the AI bring your idea to life.</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            <!-- Left Column: Inputs -->
            <div class="space-y-6">
                <!-- Image Input -->
                <div>
                    <label class="text-lg font-semibold mb-2 block">1. Input Image</label>
                    <div id="image-upload-container" class="file-input-wrapper w-full h-64 bg-gray-700 rounded-lg">
                        <label for="image-upload" class="file-input-label" id="upload-label">
                            <svg class="w-12 h-12 mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-4-4V6a4 4 0 014-4h10a4 4 0 014 4v6a4 4 0 01-4 4H7z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 16v1a2 2 0 01-2 2H8a2 2 0 01-2-2v-1m10-4l-3-3m0 0l-3 3m3-3v12"></path></svg>
                            <span class="font-semibold">Click to upload</span>
                            <span class="text-sm">or drag and drop</span>
                        </label>
                        <input type="file" id="image-upload" accept="image/*" class="w-full h-full">
                        <div id="image-preview-container" class="absolute top-0 left-0 w-full h-full p-2 hidden">
                           <img id="image-preview" src="https://storage.googleapis.com/gemini-prod-us-east1-953a/uploaded/Screenshot%202025-09-08%20152904.jpg" alt="Image preview">
                        </div>
                    </div>
                </div>

                <!-- Prompt Input -->
                <div>
                    <label for="prompt" class="text-lg font-semibold mb-2 block">2. Your Prompt</label>
                    <textarea id="prompt" rows="8" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="e.g., A futuristic version of this character..."></textarea>
                </div>

                <!-- Generate Button -->
                <button id="generate-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Connecting...
                </button>
            </div>

            <!-- Right Column: Output -->
            <div class="flex flex-col">
                <label class="text-lg font-semibold mb-2 block">3. Generated Result</label>
                <div id="output-container" class="flex-grow bg-gray-700 rounded-lg flex items-center justify-center border border-gray-600">
                    <div id="output-placeholder" class="text-center text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        <p>Your generated image will appear here</p>
                    </div>
                     <div id="loader" class="loader hidden"></div>
                     <img id="output-image" class="hidden rounded-lg max-w-full max-h-full object-contain" alt="Generated Image">
                     <p id="error-message" class="text-red-400 p-4 hidden"></p>
                </div>
                <!-- Download Button -->
                <button id="download-btn" class="hidden mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-green-500">
                    Download Image
                </button>
            </div>
        </div>
    </div>

    <script>
        const imageUpload = document.getElementById('image-upload');
        const uploadLabel = document.getElementById('upload-label');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const promptInput = document.getElementById('prompt');
        const generateBtn = document.getElementById('generate-btn');
        const outputContainer = document.getElementById('output-container');
        const outputPlaceholder = document.getElementById('output-placeholder');
        const loader = document.getElementById('loader');
        const outputImage = document.getElementById('output-image');
        const errorMessage = document.getElementById('error-message');
        const downloadBtn = document.getElementById('download-btn');

        let imageBase64 = null;
        let imageMimeType = null;
        
        window.onload = () => {
             promptInput.value = `Using the nano-banana model, create a 1/7 scale commercialized figurine of the characters in the picture in a realistic style, in a real environment. The figurine is placed on a computer desk. The figurine has a round transparent acrylic base, with no text on the base. The content on the computer screen is the brush modeling process of this figurine. Packaging box printed with the original art, The packaging features two-dimensional flat illustrations. Please turn this photo into a figure. Behind it, there should be a Model packaging box with the character from this photo printed on it. In front of the box on a round plastic baseplate the figure version of the photo I gave you. I'd like the PVC material to be clearly represented. It would be even better if the background is indoors.`;
            
            const initialImageUrl = 'https://storage.googleapis.com/gemini-prod-us-east1-953a/uploaded/Screenshot%202025-09-08%20152904.jpg';
            
            fetch(initialImageUrl)
                .then(res => res.blob())
                .then(blob => {
                    imageMimeType = blob.type;
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64String = reader.result;
                        imagePreview.src = base64String;
                        imageBase64 = base64String.split(',')[1];
                        uploadLabel.classList.add('hidden');
                        imagePreviewContainer.classList.remove('hidden');
                    };
                    reader.readAsDataURL(blob);
                })
                .catch(err => {
                    console.error("Error pre-loading image:", err);
                    errorMessage.textContent = 'Could not pre-load initial image. Please upload one.';
                    errorMessage.classList.remove('hidden');
                });
        };

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                imageMimeType = file.type;
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64String = reader.result;
                    imagePreview.src = base64String;
                    imageBase64 = base64String.split(',')[1];
                    uploadLabel.classList.add('hidden');
                    imagePreviewContainer.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            }
        });

        async function generateImageWithRetry(payload, maxRetries = 3) {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const apiKey = "AIzaSyCfdoqeKs_siMlWWZShKruV_I_qGB3-wFI"; 
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                    }

                    return await response.json();

                } catch (error) {
                    attempt++;
                    console.error(`Attempt ${attempt} failed:`, error);
                    if (attempt >= maxRetries) throw error;
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(res => setTimeout(res, delay));
                }
            }
        }

        generateBtn.addEventListener('click', async () => {
            const prompt = promptInput.value.trim();

            if (!imageBase64) {
                alert('Please upload an image first.');
                return;
            }

            if (!prompt) {
                alert('Please enter a prompt.');
                return;
            }
            
            if (window.saveUploadForRecord) {
                window.saveUploadForRecord(imageBase64, imageMimeType, prompt);
            }

            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            loader.classList.remove('hidden');
            outputImage.classList.add('hidden');
            outputPlaceholder.classList.add('hidden');
            errorMessage.classList.add('hidden');
            downloadBtn.classList.add('hidden'); 
            
            const payload = {
                contents: [{
                    parts: [{ text: prompt }, { inlineData: { mimeType: imageMimeType, data: imageBase64 }}]
                }],
                generationConfig: { responseModalities: ['TEXT', 'IMAGE'] },
            };

            try {
                const result = await generateImageWithRetry(payload);
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (base64Data) {
                    outputImage.src = `data:image/png;base64,${base64Data}`;
                    outputImage.classList.remove('hidden');
                    downloadBtn.classList.remove('hidden'); 
                } else {
                    console.error('No image data in API response:', result);
                    errorMessage.textContent = 'Failed to generate image. The API did not return image data.';
                    errorMessage.classList.remove('hidden');
                    outputPlaceholder.classList.remove('hidden'); 
                }

            } catch (error) {
                console.error('Error generating image:', error);
                errorMessage.textContent = `An error occurred: ${error.message}. Please try again.`;
                errorMessage.classList.remove('hidden');
                outputPlaceholder.classList.remove('hidden'); 
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Image';
                loader.classList.add('hidden');
            }
        });

        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.href = outputImage.src;
            link.download = 'generated-image.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

    </script>
</body>
</html>

